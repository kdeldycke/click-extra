---
name: Tests
"on":
  push:
    branches:
      - main
  pull_request:
  schedule:
    # Run tests every Monday at 9:17 to catch regressions.
    - cron: "17 9 * * 1"

concurrency:
  # Group workflow jobs so new commits cancels in-progress execution triggered by previous commits. Source:
  # https://mail.python.org/archives/list/pypa-committers@python.org/thread/PCBCQMJF64JGRBOX7E2EE4YLKHT4DI55/
  # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:

  tests:
    strategy:
      # We delegate the failure decision to each job, by the way of the "continue-on-error" flag.
      fail-fast: false
      matrix:
        # Available OS: https://github.com/actions/runner-images#available-images
        # Only targets 2 variants per platforms to keep the matrix small.
        os:
          - ubuntu-24.04-arm # arm64
          - ubuntu-slim      # x86
          - macos-26         # arm64
          - macos-15-intel   # x86
          - windows-11-arm   # arm64
          - windows-2025     # x86
        python-version:
          - "3.10"
          # Ignore intermediate versions to reduce CI load.
          # - "3.11"
          # - "3.12"
          # - "3.13"
          - "3.14"
          - "3.14t"
          - "3.15"
          - "3.15t"
        click-version:
          - released
          - stable
          - main
        cloup-version:
          - released
          - master
        # Removes from the matrix some combinations for development versions of Click and Cloup. This reduce the size
        # of the matrix for tests on non-released versions. While keeping the full exhaustive tests on the released
        # versions of Click and Cloup.
        # XXX Ideally, the exclude section below could be reduced to:
        #   exclude:
        #     - click-version: stable
        #       os:
        #         - ubuntu-slim
        #         - macos-15-intel
        #         - windows-2025
        #       python-version:
        #         - "3.10"
        #         - "3.11"
        #         - "3.12"
        #         - "3.13"
        #         - "3.15"
        #         - "3.15t"
        #     - click-version: main
        #       os:
        #         - ubuntu-slim
        #         - macos-15-intel
        #         - windows-2025
        #       python-version:
        #         - "3.10"
        #         - "3.11"
        #         - "3.12"
        #         - "3.13"
        #         - "3.15"
        #         - "3.15t"
        #     - cloup-version: master
        #       os:
        #         - ubuntu-slim
        #         - macos-15-intel
        #         - windows-2025
        #       python-version:
        #         - "3.10"
        #         - "3.11"
        #         - "3.12"
        #         - "3.13"
        #         - "3.15"
        #         - "3.15t"
        exclude:
          # Only targets the latest OS for each platform.
          - os: ubuntu-slim
            click-version: stable
          - os: ubuntu-slim
            click-version: main
          - os: ubuntu-slim
            cloup-version: master
          - os: macos-15-intel
            click-version: stable
          - os: macos-15-intel
            click-version: main
          - os: macos-15-intel
            cloup-version: master
          - os: windows-2025
            click-version: stable
          - os: windows-2025
            click-version: main
          - os: windows-2025
            cloup-version: master
          # Exclude old Python version. Only test on latest stable release.
          - python-version: "3.10"
            click-version: stable
          - python-version: "3.10"
            click-version: main
          - python-version: "3.10"
            cloup-version: master
          # Exclude Python's dev version.
          - python-version: "3.15"
            click-version: stable
          - python-version: "3.15"
            click-version: main
          - python-version: "3.15"
            cloup-version: master
          - python-version: "3.15t"
            click-version: stable
          - python-version: "3.15t"
            click-version: main
          - python-version: "3.15t"
            cloup-version: master
        include:
          # Default all jobs as stable, unless marked otherwise below.
          - state: stable
          # XXX Python 3.15 is still in development.
          - state: unstable
            python-version: "3.15"
          - state: unstable
            python-version: "3.15t"
    name: |
      ${{ matrix.state == 'stable' && '✅' || '⁉️' }}
      ${{ matrix.os }},
      py${{ matrix.python-version }},
      Click ${{ matrix.click-version }},
      Cloup ${{ matrix.cloup-version }}
    runs-on: ${{ matrix.os }}
    # We keep going when a job flagged as not stable fails.
    continue-on-error: ${{ matrix.state == 'unstable' }}
    steps:
      - name: Unlock CPU on macos-15-intel
        if: matrix.os == 'macos-15-intel'
        # See https://github.com/actions/runner-images/issues/13358
        run: |
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0
          sudo killall PerfPowerServices || true
      - uses: actions/checkout@v6.0.0
      - uses: astral-sh/setup-uv@v7.1.4
      - name: Install Python ${{ matrix.python-version }}
        # If UV cannot find the requested Python version, it exits with code 2, which let the job pass unnoticed on
        # Windows. So we force the shell to bash, even on Windows, and "set -e" to ensure any error in the install
        # process is caught and fails the job. It works because Windows runners too Git Bash available).
        shell: bash
        run: |
          set -e
          uv --no-progress venv --python ${{ matrix.python-version }}
      - name: Install project
        # Install all extras, so we can check any incompatibility.
        run: >
          uv --no-progress sync --frozen --all-extras --group test

      - name: Run local CLI
        run: |
          uv run -- click-extra-demo --version
      - name: Run CLI from module
        run: |
          uv run        -m click_extra --version
          uv run python -m click_extra --version
      - name: Run stable CLI
        run: |
          uvx    --from click-extra -- click-extra-demo --version
          uv run --with click-extra -- click-extra-demo --version
      - name: Run dev CLI
        run: |
          uvx    --from git+https://github.com/kdeldycke/click-extra -- click-extra-demo --version
          uv run --with git+https://github.com/kdeldycke/click-extra -- click-extra-demo --version

      - name: Unittests
        run: >
          uv --no-progress run --frozen
          ${{ matrix.click-version != 'released'
          && format('--with "git+https://github.com/pallets/click.git@{0}"', matrix.click-version) || '' }}
          ${{ matrix.cloup-version != 'released'
          && format('--with "git+https://github.com/janluke/cloup.git@{0}"', matrix.cloup-version) || ''}}
          --
          pytest

      - name: Codecov - coverage
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Codecov - test results
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1.1.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}